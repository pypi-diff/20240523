# Comparing `tmp/nucliadb_utils-4.0.0.post535-py3-none-any.whl.zip` & `tmp/nucliadb_utils-4.0.0.post536-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,72 +1,78 @@
-Zip file size: 106883 bytes, number of entries: 70
--rw-r--r--  2.0 unx      895 b- defN 24-May-23 07:48 nucliadb_utils/__init__.py
--rw-r--r--  2.0 unx     2894 b- defN 24-May-23 07:48 nucliadb_utils/asyncio_utils.py
--rw-r--r--  2.0 unx     6071 b- defN 24-May-23 07:48 nucliadb_utils/authentication.py
--rw-r--r--  2.0 unx     2391 b- defN 24-May-23 07:48 nucliadb_utils/const.py
--rw-r--r--  2.0 unx     2470 b- defN 24-May-23 07:48 nucliadb_utils/debug.py
--rw-r--r--  2.0 unx     1094 b- defN 24-May-23 07:48 nucliadb_utils/exceptions.py
--rw-r--r--  2.0 unx     2740 b- defN 24-May-23 07:48 nucliadb_utils/featureflagging.py
--rw-r--r--  2.0 unx     3336 b- defN 24-May-23 07:48 nucliadb_utils/grpc.py
--rw-r--r--  2.0 unx     1599 b- defN 24-May-23 07:48 nucliadb_utils/helpers.py
--rw-r--r--  2.0 unx     3462 b- defN 24-May-23 07:48 nucliadb_utils/indexing.py
--rw-r--r--  2.0 unx     8224 b- defN 24-May-23 07:48 nucliadb_utils/nats.py
--rw-r--r--  2.0 unx     1173 b- defN 24-May-23 07:48 nucliadb_utils/partition.py
--rw-r--r--  2.0 unx        0 b- defN 24-May-23 07:48 nucliadb_utils/py.typed
--rw-r--r--  2.0 unx     1713 b- defN 24-May-23 07:48 nucliadb_utils/run.py
--rw-r--r--  2.0 unx     7280 b- defN 24-May-23 07:48 nucliadb_utils/settings.py
--rw-r--r--  2.0 unx     2702 b- defN 24-May-23 07:48 nucliadb_utils/signals.py
--rw-r--r--  2.0 unx      890 b- defN 24-May-23 07:48 nucliadb_utils/store.py
--rw-r--r--  2.0 unx     7212 b- defN 24-May-23 07:48 nucliadb_utils/transaction.py
--rw-r--r--  2.0 unx    14178 b- defN 24-May-23 07:48 nucliadb_utils/utilities.py
--rw-r--r--  2.0 unx      835 b- defN 24-May-23 07:48 nucliadb_utils/audit/__init__.py
--rw-r--r--  2.0 unx     2698 b- defN 24-May-23 07:48 nucliadb_utils/audit/audit.py
--rw-r--r--  2.0 unx     3267 b- defN 24-May-23 07:48 nucliadb_utils/audit/basic.py
--rw-r--r--  2.0 unx     9388 b- defN 24-May-23 07:48 nucliadb_utils/audit/stream.py
--rw-r--r--  2.0 unx      833 b- defN 24-May-23 07:48 nucliadb_utils/cache/__init__.py
--rw-r--r--  2.0 unx      975 b- defN 24-May-23 07:48 nucliadb_utils/cache/exceptions.py
--rw-r--r--  2.0 unx     7089 b- defN 24-May-23 07:48 nucliadb_utils/cache/nats.py
--rw-r--r--  2.0 unx     1654 b- defN 24-May-23 07:48 nucliadb_utils/cache/pubsub.py
--rw-r--r--  2.0 unx     1059 b- defN 24-May-23 07:48 nucliadb_utils/cache/settings.py
--rw-r--r--  2.0 unx      833 b- defN 24-May-23 07:48 nucliadb_utils/fastapi/__init__.py
--rw-r--r--  2.0 unx     1737 b- defN 24-May-23 07:48 nucliadb_utils/fastapi/openapi.py
--rw-r--r--  2.0 unx     3631 b- defN 24-May-23 07:48 nucliadb_utils/fastapi/run.py
--rw-r--r--  2.0 unx     3774 b- defN 24-May-23 07:48 nucliadb_utils/fastapi/versioning.py
--rw-r--r--  2.0 unx      872 b- defN 24-May-23 07:48 nucliadb_utils/storages/__init__.py
--rw-r--r--  2.0 unx     2417 b- defN 24-May-23 07:48 nucliadb_utils/storages/exceptions.py
--rw-r--r--  2.0 unx    27076 b- defN 24-May-23 07:48 nucliadb_utils/storages/gcs.py
--rw-r--r--  2.0 unx    10074 b- defN 24-May-23 07:48 nucliadb_utils/storages/local.py
--rw-r--r--  2.0 unx     2097 b- defN 24-May-23 07:48 nucliadb_utils/storages/nuclia.py
--rw-r--r--  2.0 unx    18610 b- defN 24-May-23 07:48 nucliadb_utils/storages/pg.py
--rw-r--r--  2.0 unx    18809 b- defN 24-May-23 07:48 nucliadb_utils/storages/s3.py
--rw-r--r--  2.0 unx     1285 b- defN 24-May-23 07:48 nucliadb_utils/storages/settings.py
--rw-r--r--  2.0 unx    20324 b- defN 24-May-23 07:48 nucliadb_utils/storages/storage.py
--rw-r--r--  2.0 unx     1456 b- defN 24-May-23 07:48 nucliadb_utils/tests/__init__.py
--rw-r--r--  2.0 unx    10698 b- defN 24-May-23 07:48 nucliadb_utils/tests/asyncbenchmark.py
--rw-r--r--  2.0 unx     1876 b- defN 24-May-23 07:48 nucliadb_utils/tests/conftest.py
--rw-r--r--  2.0 unx     3098 b- defN 24-May-23 07:48 nucliadb_utils/tests/gcs.py
--rw-r--r--  2.0 unx     1513 b- defN 24-May-23 07:48 nucliadb_utils/tests/indexing.py
--rw-r--r--  2.0 unx     1343 b- defN 24-May-23 07:48 nucliadb_utils/tests/local.py
--rw-r--r--  2.0 unx     7701 b- defN 24-May-23 07:48 nucliadb_utils/tests/nats.py
--rw-r--r--  2.0 unx     1819 b- defN 24-May-23 07:48 nucliadb_utils/tests/pg.py
--rw-r--r--  2.0 unx     2330 b- defN 24-May-23 07:48 nucliadb_utils/tests/s3.py
--rw-r--r--  2.0 unx      833 b- defN 24-May-23 07:48 nucliadb_utils/tests/unit/__init__.py
--rw-r--r--  2.0 unx     2359 b- defN 24-May-23 07:48 nucliadb_utils/tests/unit/test_asyncio_utils.py
--rw-r--r--  2.0 unx     5301 b- defN 24-May-23 07:48 nucliadb_utils/tests/unit/test_authentication.py
--rw-r--r--  2.0 unx     1574 b- defN 24-May-23 07:48 nucliadb_utils/tests/unit/test_helpers.py
--rw-r--r--  2.0 unx     4436 b- defN 24-May-23 07:48 nucliadb_utils/tests/unit/test_nats.py
--rw-r--r--  2.0 unx     1910 b- defN 24-May-23 07:48 nucliadb_utils/tests/unit/test_run.py
--rw-r--r--  2.0 unx     2647 b- defN 24-May-23 07:48 nucliadb_utils/tests/unit/test_signals.py
--rw-r--r--  2.0 unx     1189 b- defN 24-May-23 07:48 nucliadb_utils/tests/unit/test_tests.py
--rw-r--r--  2.0 unx     3917 b- defN 24-May-23 07:48 nucliadb_utils/tests/unit/test_transaction.py
--rw-r--r--  2.0 unx     5377 b- defN 24-May-23 07:48 nucliadb_utils/tests/unit/test_utilities.py
--rw-r--r--  2.0 unx      833 b- defN 24-May-23 07:48 nucliadb_utils/tests/unit/storages/__init__.py
--rw-r--r--  2.0 unx     1924 b- defN 24-May-23 07:48 nucliadb_utils/tests/unit/storages/test_aws.py
--rw-r--r--  2.0 unx     3554 b- defN 24-May-23 07:48 nucliadb_utils/tests/unit/storages/test_gcs.py
--rw-r--r--  2.0 unx    17000 b- defN 24-May-23 07:48 nucliadb_utils/tests/unit/storages/test_pg.py
--rw-r--r--  2.0 unx     6666 b- defN 24-May-23 07:48 nucliadb_utils/tests/unit/storages/test_storage.py
--rw-r--r--  2.0 unx     1979 b- defN 24-May-23 07:49 nucliadb_utils-4.0.0.post535.dist-info/METADATA
--rw-r--r--  2.0 unx       92 b- defN 24-May-23 07:49 nucliadb_utils-4.0.0.post535.dist-info/WHEEL
--rw-r--r--  2.0 unx       15 b- defN 24-May-23 07:49 nucliadb_utils-4.0.0.post535.dist-info/top_level.txt
--rw-r--r--  2.0 unx        1 b- defN 24-May-23 07:49 nucliadb_utils-4.0.0.post535.dist-info/zip-safe
--rw-rw-r--  2.0 unx     6273 b- defN 24-May-23 07:49 nucliadb_utils-4.0.0.post535.dist-info/RECORD
-70 files, 309375 bytes uncompressed, 96845 bytes compressed:  68.7%
+Zip file size: 114105 bytes, number of entries: 76
+-rw-r--r--  2.0 unx      895 b- defN 24-May-23 08:45 nucliadb_utils/__init__.py
+-rw-r--r--  2.0 unx     2894 b- defN 24-May-23 08:45 nucliadb_utils/asyncio_utils.py
+-rw-r--r--  2.0 unx     6071 b- defN 24-May-23 08:45 nucliadb_utils/authentication.py
+-rw-r--r--  2.0 unx     2391 b- defN 24-May-23 08:45 nucliadb_utils/const.py
+-rw-r--r--  2.0 unx     2470 b- defN 24-May-23 08:45 nucliadb_utils/debug.py
+-rw-r--r--  2.0 unx     1094 b- defN 24-May-23 08:45 nucliadb_utils/exceptions.py
+-rw-r--r--  2.0 unx     2740 b- defN 24-May-23 08:45 nucliadb_utils/featureflagging.py
+-rw-r--r--  2.0 unx     3336 b- defN 24-May-23 08:45 nucliadb_utils/grpc.py
+-rw-r--r--  2.0 unx     1599 b- defN 24-May-23 08:45 nucliadb_utils/helpers.py
+-rw-r--r--  2.0 unx     3462 b- defN 24-May-23 08:45 nucliadb_utils/indexing.py
+-rw-r--r--  2.0 unx     8224 b- defN 24-May-23 08:45 nucliadb_utils/nats.py
+-rw-r--r--  2.0 unx     1173 b- defN 24-May-23 08:45 nucliadb_utils/partition.py
+-rw-r--r--  2.0 unx        0 b- defN 24-May-23 08:45 nucliadb_utils/py.typed
+-rw-r--r--  2.0 unx     1713 b- defN 24-May-23 08:45 nucliadb_utils/run.py
+-rw-r--r--  2.0 unx     7280 b- defN 24-May-23 08:45 nucliadb_utils/settings.py
+-rw-r--r--  2.0 unx     2702 b- defN 24-May-23 08:45 nucliadb_utils/signals.py
+-rw-r--r--  2.0 unx      890 b- defN 24-May-23 08:45 nucliadb_utils/store.py
+-rw-r--r--  2.0 unx     7212 b- defN 24-May-23 08:45 nucliadb_utils/transaction.py
+-rw-r--r--  2.0 unx    14178 b- defN 24-May-23 08:45 nucliadb_utils/utilities.py
+-rw-r--r--  2.0 unx      835 b- defN 24-May-23 08:45 nucliadb_utils/audit/__init__.py
+-rw-r--r--  2.0 unx     2834 b- defN 24-May-23 08:45 nucliadb_utils/audit/audit.py
+-rw-r--r--  2.0 unx     3430 b- defN 24-May-23 08:45 nucliadb_utils/audit/basic.py
+-rw-r--r--  2.0 unx    12038 b- defN 24-May-23 08:45 nucliadb_utils/audit/stream.py
+-rw-r--r--  2.0 unx      833 b- defN 24-May-23 08:45 nucliadb_utils/cache/__init__.py
+-rw-r--r--  2.0 unx      975 b- defN 24-May-23 08:45 nucliadb_utils/cache/exceptions.py
+-rw-r--r--  2.0 unx     7089 b- defN 24-May-23 08:45 nucliadb_utils/cache/nats.py
+-rw-r--r--  2.0 unx     1654 b- defN 24-May-23 08:45 nucliadb_utils/cache/pubsub.py
+-rw-r--r--  2.0 unx     1059 b- defN 24-May-23 08:45 nucliadb_utils/cache/settings.py
+-rw-r--r--  2.0 unx      833 b- defN 24-May-23 08:45 nucliadb_utils/fastapi/__init__.py
+-rw-r--r--  2.0 unx     1737 b- defN 24-May-23 08:45 nucliadb_utils/fastapi/openapi.py
+-rw-r--r--  2.0 unx     3631 b- defN 24-May-23 08:45 nucliadb_utils/fastapi/run.py
+-rw-r--r--  2.0 unx     3774 b- defN 24-May-23 08:45 nucliadb_utils/fastapi/versioning.py
+-rw-r--r--  2.0 unx      835 b- defN 24-May-23 08:45 nucliadb_utils/nuclia_usage/__init__.py
+-rw-r--r--  2.0 unx      835 b- defN 24-May-23 08:45 nucliadb_utils/nuclia_usage/protos/__init__.py
+-rw-r--r--  2.0 unx     5934 b- defN 24-May-23 08:45 nucliadb_utils/nuclia_usage/protos/kb_usage_pb2.py
+-rw-r--r--  2.0 unx     1008 b- defN 24-May-23 08:45 nucliadb_utils/nuclia_usage/protos/kb_usage_pb2_grpc.py
+-rw-r--r--  2.0 unx      835 b- defN 24-May-23 08:45 nucliadb_utils/nuclia_usage/utils/__init__.py
+-rw-r--r--  2.0 unx     3870 b- defN 24-May-23 08:45 nucliadb_utils/nuclia_usage/utils/kb_usage_report.py
+-rw-r--r--  2.0 unx      872 b- defN 24-May-23 08:45 nucliadb_utils/storages/__init__.py
+-rw-r--r--  2.0 unx     2417 b- defN 24-May-23 08:45 nucliadb_utils/storages/exceptions.py
+-rw-r--r--  2.0 unx    27076 b- defN 24-May-23 08:45 nucliadb_utils/storages/gcs.py
+-rw-r--r--  2.0 unx    10074 b- defN 24-May-23 08:45 nucliadb_utils/storages/local.py
+-rw-r--r--  2.0 unx     2097 b- defN 24-May-23 08:45 nucliadb_utils/storages/nuclia.py
+-rw-r--r--  2.0 unx    18610 b- defN 24-May-23 08:45 nucliadb_utils/storages/pg.py
+-rw-r--r--  2.0 unx    18809 b- defN 24-May-23 08:45 nucliadb_utils/storages/s3.py
+-rw-r--r--  2.0 unx     1285 b- defN 24-May-23 08:45 nucliadb_utils/storages/settings.py
+-rw-r--r--  2.0 unx    20324 b- defN 24-May-23 08:45 nucliadb_utils/storages/storage.py
+-rw-r--r--  2.0 unx     1456 b- defN 24-May-23 08:45 nucliadb_utils/tests/__init__.py
+-rw-r--r--  2.0 unx    10698 b- defN 24-May-23 08:45 nucliadb_utils/tests/asyncbenchmark.py
+-rw-r--r--  2.0 unx     1876 b- defN 24-May-23 08:45 nucliadb_utils/tests/conftest.py
+-rw-r--r--  2.0 unx     3098 b- defN 24-May-23 08:45 nucliadb_utils/tests/gcs.py
+-rw-r--r--  2.0 unx     1513 b- defN 24-May-23 08:45 nucliadb_utils/tests/indexing.py
+-rw-r--r--  2.0 unx     1343 b- defN 24-May-23 08:45 nucliadb_utils/tests/local.py
+-rw-r--r--  2.0 unx     7701 b- defN 24-May-23 08:45 nucliadb_utils/tests/nats.py
+-rw-r--r--  2.0 unx     1819 b- defN 24-May-23 08:45 nucliadb_utils/tests/pg.py
+-rw-r--r--  2.0 unx     2330 b- defN 24-May-23 08:45 nucliadb_utils/tests/s3.py
+-rw-r--r--  2.0 unx      833 b- defN 24-May-23 08:45 nucliadb_utils/tests/unit/__init__.py
+-rw-r--r--  2.0 unx     2359 b- defN 24-May-23 08:45 nucliadb_utils/tests/unit/test_asyncio_utils.py
+-rw-r--r--  2.0 unx     5301 b- defN 24-May-23 08:45 nucliadb_utils/tests/unit/test_authentication.py
+-rw-r--r--  2.0 unx     1574 b- defN 24-May-23 08:45 nucliadb_utils/tests/unit/test_helpers.py
+-rw-r--r--  2.0 unx     4436 b- defN 24-May-23 08:45 nucliadb_utils/tests/unit/test_nats.py
+-rw-r--r--  2.0 unx     1910 b- defN 24-May-23 08:45 nucliadb_utils/tests/unit/test_run.py
+-rw-r--r--  2.0 unx     2647 b- defN 24-May-23 08:45 nucliadb_utils/tests/unit/test_signals.py
+-rw-r--r--  2.0 unx     1189 b- defN 24-May-23 08:45 nucliadb_utils/tests/unit/test_tests.py
+-rw-r--r--  2.0 unx     3917 b- defN 24-May-23 08:45 nucliadb_utils/tests/unit/test_transaction.py
+-rw-r--r--  2.0 unx     5377 b- defN 24-May-23 08:45 nucliadb_utils/tests/unit/test_utilities.py
+-rw-r--r--  2.0 unx      833 b- defN 24-May-23 08:45 nucliadb_utils/tests/unit/storages/__init__.py
+-rw-r--r--  2.0 unx     1924 b- defN 24-May-23 08:45 nucliadb_utils/tests/unit/storages/test_aws.py
+-rw-r--r--  2.0 unx     3554 b- defN 24-May-23 08:45 nucliadb_utils/tests/unit/storages/test_gcs.py
+-rw-r--r--  2.0 unx    17000 b- defN 24-May-23 08:45 nucliadb_utils/tests/unit/storages/test_pg.py
+-rw-r--r--  2.0 unx     6666 b- defN 24-May-23 08:45 nucliadb_utils/tests/unit/storages/test_storage.py
+-rw-r--r--  2.0 unx     1979 b- defN 24-May-23 08:46 nucliadb_utils-4.0.0.post536.dist-info/METADATA
+-rw-r--r--  2.0 unx       92 b- defN 24-May-23 08:46 nucliadb_utils-4.0.0.post536.dist-info/WHEEL
+-rw-r--r--  2.0 unx       15 b- defN 24-May-23 08:46 nucliadb_utils-4.0.0.post536.dist-info/top_level.txt
+-rw-r--r--  2.0 unx        1 b- defN 24-May-23 08:46 nucliadb_utils-4.0.0.post536.dist-info/zip-safe
+-rw-rw-r--  2.0 unx     6900 b- defN 24-May-23 08:46 nucliadb_utils-4.0.0.post536.dist-info/RECORD
+76 files, 326268 bytes uncompressed, 103037 bytes compressed:  68.4%
```

## zipnote {}

```diff
@@ -90,14 +90,32 @@
 
 Filename: nucliadb_utils/fastapi/run.py
 Comment: 
 
 Filename: nucliadb_utils/fastapi/versioning.py
 Comment: 
 
+Filename: nucliadb_utils/nuclia_usage/__init__.py
+Comment: 
+
+Filename: nucliadb_utils/nuclia_usage/protos/__init__.py
+Comment: 
+
+Filename: nucliadb_utils/nuclia_usage/protos/kb_usage_pb2.py
+Comment: 
+
+Filename: nucliadb_utils/nuclia_usage/protos/kb_usage_pb2_grpc.py
+Comment: 
+
+Filename: nucliadb_utils/nuclia_usage/utils/__init__.py
+Comment: 
+
+Filename: nucliadb_utils/nuclia_usage/utils/kb_usage_report.py
+Comment: 
+
 Filename: nucliadb_utils/storages/__init__.py
 Comment: 
 
 Filename: nucliadb_utils/storages/exceptions.py
 Comment: 
 
 Filename: nucliadb_utils/storages/gcs.py
@@ -189,23 +207,23 @@
 
 Filename: nucliadb_utils/tests/unit/storages/test_pg.py
 Comment: 
 
 Filename: nucliadb_utils/tests/unit/storages/test_storage.py
 Comment: 
 
-Filename: nucliadb_utils-4.0.0.post535.dist-info/METADATA
+Filename: nucliadb_utils-4.0.0.post536.dist-info/METADATA
 Comment: 
 
-Filename: nucliadb_utils-4.0.0.post535.dist-info/WHEEL
+Filename: nucliadb_utils-4.0.0.post536.dist-info/WHEEL
 Comment: 
 
-Filename: nucliadb_utils-4.0.0.post535.dist-info/top_level.txt
+Filename: nucliadb_utils-4.0.0.post536.dist-info/top_level.txt
 Comment: 
 
-Filename: nucliadb_utils-4.0.0.post535.dist-info/zip-safe
+Filename: nucliadb_utils-4.0.0.post536.dist-info/zip-safe
 Comment: 
 
-Filename: nucliadb_utils-4.0.0.post535.dist-info/RECORD
+Filename: nucliadb_utils-4.0.0.post536.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## nucliadb_utils/audit/audit.py

```diff
@@ -42,14 +42,22 @@
         rid: Optional[str] = None,
         field_metadata: Optional[List[FieldID]] = None,
         audit_fields: Optional[List[AuditField]] = None,
         kb_counter: Optional[AuditKBCounter] = None,
     ):  # type: ignore
         raise NotImplementedError
 
+    def report_resources(
+        self,
+        *,
+        kbid: str,
+        resources: int,
+    ):
+        raise NotImplementedError
+
     async def initialize(self):
         pass
 
     async def finalize(self):
         pass
 
     async def visited(self, kbid: str, uuid: str, user: str, origin: str):
```

## nucliadb_utils/audit/basic.py

```diff
@@ -51,14 +51,22 @@
         audit_fields: Optional[List[AuditField]] = None,
         kb_counter: Optional[AuditKBCounter] = None,
     ):  # type: ignore
         logger.debug(
             f"AUDIT {audit_type} {kbid} {user} {origin} {rid} {audit_fields} {kb_counter}"
         )
 
+    def report_resources(
+        self,
+        *,
+        kbid: str,
+        resources: int,
+    ):
+        logger.debug(f"REPORT RESOURCES {kbid} {resources}")
+
     async def visited(self, kbid: str, uuid: str, user: str, origin: str):
         logger.debug(f"VISITED {kbid} {uuid} {user} {origin}")
 
     async def search(
         self,
         kbid: str,
         user: str,
```

## nucliadb_utils/audit/stream.py

```diff
@@ -26,22 +26,36 @@
 import nats
 from google.protobuf.timestamp_pb2 import Timestamp
 from nucliadb_protos.audit_pb2 import (
     AuditField,
     AuditKBCounter,
     AuditRequest,
     ChatContext,
+    ClientType,
 )
 from nucliadb_protos.nodereader_pb2 import SearchRequest
 from nucliadb_protos.resources_pb2 import FieldID
 from opentelemetry.trace import format_trace_id, get_current_span
 
 from nucliadb_utils import logger
 from nucliadb_utils.audit.audit import AuditStorage
 from nucliadb_utils.nats import get_traced_jetstream
+from nucliadb_utils.nuclia_usage.protos.kb_usage_pb2 import (
+    ClientType as ClientTypeKbUsage,
+)
+from nucliadb_utils.nuclia_usage.protos.kb_usage_pb2 import (
+    KBSource,
+    Search,
+    SearchType,
+    Service,
+    Storage,
+)
+from nucliadb_utils.nuclia_usage.utils.kb_usage_report import KbUsageReportUtility
+
+KB_USAGE_STREAM_AUDIT = "kb-usage.audit"
 
 
 class StreamAuditStorage(AuditStorage):
     task: Optional[asyncio.Task] = None
     initialized: bool = False
     queue: asyncio.Queue
     lock: asyncio.Lock
@@ -95,17 +109,25 @@
         if len(self.nats_servers) > 0:
             options["servers"] = self.nats_servers
 
         self.nc = await nats.connect(**options)
 
         self.js = get_traced_jetstream(self.nc, self.service)
         self.task = asyncio.create_task(self.run())
+
+        self.kb_usage_utility = KbUsageReportUtility(
+            nats_stream=self.js, nats_subject=KB_USAGE_STREAM_AUDIT
+        )
+        await self.kb_usage_utility.initialize()
+
         self.initialized = True
 
     async def finalize(self):
+        await self.kb_usage_utility.finalize()
+
         if self.task is not None:
             self.task.cancel()
         if self.nc:
             await self.nc.flush()
             await self.nc.close()
             self.nc = None
 
@@ -174,18 +196,42 @@
 
         if audit_fields:
             auditrequest.fields_audit.extend(audit_fields)
 
         if kb_counter:
             auditrequest.kb_counter.CopyFrom(kb_counter)
 
+            self.kb_usage_utility.send_kb_usage(
+                service=Service.NUCLIA_DB,
+                account_id=None,
+                kb_id=kbid,
+                kb_source=KBSource.HOSTED,
+                storage=Storage(
+                    paragraphs=kb_counter.paragraphs, fields=kb_counter.fields
+                ),
+            )
+
         auditrequest.trace_id = get_trace_id()
 
         await self.send(auditrequest)
 
+    def report_resources(
+        self,
+        *,
+        kbid: str,
+        resources: int,
+    ):
+        self.kb_usage_utility.send_kb_usage(
+            service=Service.NUCLIA_DB,
+            account_id=None,
+            kb_id=kbid,
+            kb_source=KBSource.HOSTED,
+            storage=Storage(resources=resources),
+        )
+
     async def visited(self, kbid: str, uuid: str, user: str, origin: str):
         auditrequest = AuditRequest()
         auditrequest.origin = origin
         auditrequest.userid = user
         auditrequest.rid = uuid
         auditrequest.kbid = kbid
         auditrequest.type = AuditRequest.VISITED
@@ -200,14 +246,22 @@
         auditrequest = AuditRequest()
         auditrequest.kbid = kbid
         auditrequest.type = AuditRequest.KB_DELETED
         auditrequest.time.FromDatetime(datetime.now())
         auditrequest.trace_id = get_trace_id()
         await self.send(auditrequest)
 
+        self.kb_usage_utility.send_kb_usage(
+            service=Service.NUCLIA_DB,
+            account_id=None,
+            kb_id=kbid,
+            kb_source=KBSource.HOSTED,
+            storage=Storage(paragraphs=0, fields=0, resources=0),
+        )
+
     async def search(
         self,
         kbid: str,
         user: str,
         client_type: int,
         origin: str,
         search: SearchRequest,
@@ -225,14 +279,30 @@
         auditrequest.resources = resources
         auditrequest.type = AuditRequest.SEARCH
         auditrequest.time.FromDatetime(datetime.now())
 
         auditrequest.trace_id = get_trace_id()
         await self.send(auditrequest)
 
+        self.kb_usage_utility.send_kb_usage(
+            service=Service.NUCLIA_DB,
+            account_id=None,
+            kb_id=kbid,
+            kb_source=KBSource.HOSTED,
+            # TODO unify AuditRequest client type and Nuclia Usage client type
+            searches=[
+                Search(
+                    client=ClientTypeKbUsage.Value(ClientType.Name(client_type)),  # type: ignore
+                    type=SearchType.SEARCH,
+                    tokens=2000,
+                    num_searches=1,
+                )
+            ],
+        )
+
     async def suggest(
         self,
         kbid: str,
         user: str,
         client_type: int,
         origin: str,
         timeit: float,
@@ -245,14 +315,30 @@
         auditrequest.timeit = timeit
         auditrequest.type = AuditRequest.SUGGEST
         auditrequest.time.FromDatetime(datetime.now())
         auditrequest.trace_id = get_trace_id()
 
         await self.send(auditrequest)
 
+        self.kb_usage_utility.send_kb_usage(
+            service=Service.NUCLIA_DB,
+            account_id=None,
+            kb_id=kbid,
+            kb_source=KBSource.HOSTED,
+            # TODO unify AuditRequest client type and Nuclia Usage client type
+            searches=[
+                Search(
+                    client=ClientTypeKbUsage.Value(ClientType.Name(client_type)),  # type: ignore
+                    type=SearchType.SUGGEST,
+                    tokens=0,
+                    num_searches=1,
+                )
+            ],
+        )
+
     async def chat(
         self,
         kbid: str,
         user: str,
         client_type: int,
         origin: str,
         timeit: float,
```

## Comparing `nucliadb_utils-4.0.0.post535.dist-info/METADATA` & `nucliadb_utils-4.0.0.post536.dist-info/METADATA`

 * *Files 2% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: nucliadb-utils
-Version: 4.0.0.post535
+Version: 4.0.0.post536
 Home-page: https://nuclia.com
 License: BSD
 Classifier: Development Status :: 4 - Beta
 Classifier: Programming Language :: Python
 Classifier: Programming Language :: Python :: 3.9
 Classifier: Programming Language :: Python :: 3.10
 Classifier: Programming Language :: Python :: 3.11
@@ -18,16 +18,16 @@
 Requires-Dist: types-requests >=2.27.7
 Requires-Dist: mmh3 >=3.0.0
 Requires-Dist: nats-py[nkeys] >=2.6.0
 Requires-Dist: PyNaCl
 Requires-Dist: pyjwt >=2.4.0
 Requires-Dist: memorylru >=1.1.2
 Requires-Dist: mrflagly
-Requires-Dist: nucliadb-protos >=4.0.0.post535
-Requires-Dist: nucliadb-telemetry >=4.0.0.post535
+Requires-Dist: nucliadb-protos >=4.0.0.post536
+Requires-Dist: nucliadb-telemetry >=4.0.0.post536
 Provides-Extra: cache
 Requires-Dist: redis >=4.3.4 ; extra == 'cache'
 Requires-Dist: orjson >=3.6.7 ; extra == 'cache'
 Requires-Dist: lru-dict >=1.1.7 ; extra == 'cache'
 Provides-Extra: fastapi
 Requires-Dist: fastapi >=0.95.2 ; extra == 'fastapi'
 Requires-Dist: uvicorn <0.19.0,>=0.16.0 ; extra == 'fastapi'
```

## Comparing `nucliadb_utils-4.0.0.post535.dist-info/RECORD` & `nucliadb_utils-4.0.0.post536.dist-info/RECORD`

 * *Files 8% similar despite different names*

```diff
@@ -14,26 +14,32 @@
 nucliadb_utils/run.py,sha256=bKMfsPEK6WdWfiPyWPUxCqcLo4tq6eOwyaf910TOwBk,1713
 nucliadb_utils/settings.py,sha256=sFvYT903OFoIz1do0kDnxVLLucQ1nJDxPPJZJyofqow,7280
 nucliadb_utils/signals.py,sha256=KxV4UUNWf4wrEbt1iJzy6PxYuTEhi6IRisKlYlq5OtM,2702
 nucliadb_utils/store.py,sha256=kQ35HemE0v4_Qg6xVqNIJi8vSFAYQtwI3rDtMsNy62Y,890
 nucliadb_utils/transaction.py,sha256=CQpsuF-E2omh4gGMxXCn0dv7vL9ctxooWpSgWGbGfBA,7212
 nucliadb_utils/utilities.py,sha256=s5MVXDj4DTtc1VPFBRxMjud3HB0xkadyQ0f7QQLb0NM,14178
 nucliadb_utils/audit/__init__.py,sha256=cp15ZcFnHvpcu_5-aK2A4uUyvuZVV_MJn4bIXMa20ks,835
-nucliadb_utils/audit/audit.py,sha256=v-e9R4hc6iVjtN2JeZk1MAhV5x_OC5s59uSv-kF3qFk,2698
-nucliadb_utils/audit/basic.py,sha256=grlJpq5Z2LSkwgxY3PaaLb9e8asuevMPOgrzG1UcUDI,3267
-nucliadb_utils/audit/stream.py,sha256=1ak13x0mJ3U-Z5wUNnOEqAGAo5HamHI3MtB_EDwbhGU,9388
+nucliadb_utils/audit/audit.py,sha256=fmEVb6ahKrkGAY-GEy4_L4ccmcGM5YKl-Vs05260_cg,2834
+nucliadb_utils/audit/basic.py,sha256=8yL7HI9MnykSt7j4QbUeRBbBsTKFIIX6hppJ3ADVLdM,3430
+nucliadb_utils/audit/stream.py,sha256=oGblTZMiTFFaXIf5684gbizspg6LxX6j3JdKTzAtMwA,12038
 nucliadb_utils/cache/__init__.py,sha256=itSI7dtTwFP55YMX4iK7JzdMHS5CQVUiB1XzQu4UBh8,833
 nucliadb_utils/cache/exceptions.py,sha256=Zu-O_-0-yctOEgoDGI92gPzWfBMRrpiAyESA62ld6MA,975
 nucliadb_utils/cache/nats.py,sha256=h0x894QNLkkvyOcmqH8ncC-d0AiHm9SjDgvPPiwxYao,7089
 nucliadb_utils/cache/pubsub.py,sha256=l8i_RwRf7OPzfmPy-gyn66xgYFs5aHidCIjEaU9VOHE,1654
 nucliadb_utils/cache/settings.py,sha256=WVeHOE6Re5i4k2hUHdFKfkoL4n83v_Z6UPBK6GHYb8g,1059
 nucliadb_utils/fastapi/__init__.py,sha256=itSI7dtTwFP55YMX4iK7JzdMHS5CQVUiB1XzQu4UBh8,833
 nucliadb_utils/fastapi/openapi.py,sha256=b0pLuri0QuzQd0elDyOVXM42YYmES_cmT-jEfsQ1G6Y,1737
 nucliadb_utils/fastapi/run.py,sha256=n6vOX64QqF1I5n4UlKnpm_ZJ24rmwfRGi-J9YMGpZzA,3631
 nucliadb_utils/fastapi/versioning.py,sha256=uOVdKl8GzBt8L1YnU5GjBsNeDdFV2yrjjYFEGqUXRgQ,3774
+nucliadb_utils/nuclia_usage/__init__.py,sha256=cp15ZcFnHvpcu_5-aK2A4uUyvuZVV_MJn4bIXMa20ks,835
+nucliadb_utils/nuclia_usage/protos/__init__.py,sha256=cp15ZcFnHvpcu_5-aK2A4uUyvuZVV_MJn4bIXMa20ks,835
+nucliadb_utils/nuclia_usage/protos/kb_usage_pb2.py,sha256=7jBWh5aFkNOU6rF_rdp-twZONgrJe3ztJdqKvRWcMM4,5934
+nucliadb_utils/nuclia_usage/protos/kb_usage_pb2_grpc.py,sha256=dhop8WwjplPfORYPYb9HtcS9gHMzqXPJQGqXYRjV-6M,1008
+nucliadb_utils/nuclia_usage/utils/__init__.py,sha256=cp15ZcFnHvpcu_5-aK2A4uUyvuZVV_MJn4bIXMa20ks,835
+nucliadb_utils/nuclia_usage/utils/kb_usage_report.py,sha256=E1eUSFXBVNzQP9Q2rWj9y3koCO5S7iKwckny_AoLKuk,3870
 nucliadb_utils/storages/__init__.py,sha256=5Qc8AUWiJv9_JbGCBpAn88AIJhwDlm0OPQpg2ZdRL4U,872
 nucliadb_utils/storages/exceptions.py,sha256=n6aBOyurWMo8mXd1XY6Psgno4VfXJ9TRbxCy67c08-g,2417
 nucliadb_utils/storages/gcs.py,sha256=-M-abojobXGwZaS1kuFXRBxwashsAaTXMStjx3QpX4U,27076
 nucliadb_utils/storages/local.py,sha256=SZrBkxnGg8DoMHlT4GaBP5LqMwi6QAe-d_eLU2MJ0RA,10074
 nucliadb_utils/storages/nuclia.py,sha256=UfvRu92eqG1v-PE-UWH2x8KEJFqDqATMmUGFmEuqSSs,2097
 nucliadb_utils/storages/pg.py,sha256=vxx8FQIToA_C6CO1uu9W080yZl0SgUVtTEWd6lQhPJc,18610
 nucliadb_utils/storages/s3.py,sha256=EYfn2CjoVL0tPFUqMaHgJYHjrSQaIUzLeNYoRa1qp-A,18809
@@ -59,12 +65,12 @@
 nucliadb_utils/tests/unit/test_transaction.py,sha256=ULVALWbMWEkH2Gq5Q8olEL8k8Kqyh5RAe0Lp9qdF1V4,3917
 nucliadb_utils/tests/unit/test_utilities.py,sha256=KcHSPp3RZyKAnscJrIwc2M3PCD3l1DWb6WuqtI6cl5o,5377
 nucliadb_utils/tests/unit/storages/__init__.py,sha256=itSI7dtTwFP55YMX4iK7JzdMHS5CQVUiB1XzQu4UBh8,833
 nucliadb_utils/tests/unit/storages/test_aws.py,sha256=GCsB_jwCUNV3Ogt8TZZEmNKAHvOlR0HGU7blrFbtJqs,1924
 nucliadb_utils/tests/unit/storages/test_gcs.py,sha256=2XzJwgNpfjVGjtE-QdZhu3ayuT1EMEXINdM-_SatPCY,3554
 nucliadb_utils/tests/unit/storages/test_pg.py,sha256=sJfUttMSzq8W1XYolAUcMxl_R5HcEzb5fpCklPeMJiY,17000
 nucliadb_utils/tests/unit/storages/test_storage.py,sha256=CwX4wO21og1pdw9IqnK4sFxBfKY3sPhQTd56AS7-Me8,6666
-nucliadb_utils-4.0.0.post535.dist-info/METADATA,sha256=yXFJtBl8gm_UbYHO4ejKDC4zmyyRCpngJY3G62MlYBo,1979
-nucliadb_utils-4.0.0.post535.dist-info/WHEEL,sha256=GJ7t_kWBFywbagK5eo9IoUwLW6oyOeTKmQ-9iHFVNxQ,92
-nucliadb_utils-4.0.0.post535.dist-info/top_level.txt,sha256=fE3vJtALTfgh7bcAWcNhcfXkNPp_eVVpbKK-2IYua3E,15
-nucliadb_utils-4.0.0.post535.dist-info/zip-safe,sha256=AbpHGcgLb-kRsJGnwFEktk7uzpZOCcBY74-YBdrKVGs,1
-nucliadb_utils-4.0.0.post535.dist-info/RECORD,,
+nucliadb_utils-4.0.0.post536.dist-info/METADATA,sha256=zGUTuozAM-3Mr0zLlNEEHZivVR7HV4OvtwQ4Q7XK7Ss,1979
+nucliadb_utils-4.0.0.post536.dist-info/WHEEL,sha256=GJ7t_kWBFywbagK5eo9IoUwLW6oyOeTKmQ-9iHFVNxQ,92
+nucliadb_utils-4.0.0.post536.dist-info/top_level.txt,sha256=fE3vJtALTfgh7bcAWcNhcfXkNPp_eVVpbKK-2IYua3E,15
+nucliadb_utils-4.0.0.post536.dist-info/zip-safe,sha256=AbpHGcgLb-kRsJGnwFEktk7uzpZOCcBY74-YBdrKVGs,1
+nucliadb_utils-4.0.0.post536.dist-info/RECORD,,
```

